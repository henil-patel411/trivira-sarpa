<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-S4NSPVMWFS"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-S4NSPVMWFS');
    </script>

    <title>ESCAPE ME</title>
    <style>
        /* --- 1. CORE VISUALS --- */
        body { 
            margin: 0; overflow: hidden; background: #050505; 
            font-family: 'Courier New', Courier, monospace; 
            touch-action: none; user-select: none; -webkit-user-select: none;
        }

        /* MECHANICAL GRID BACKGROUND */
        .mech-grid {
            position: fixed; inset: 0; z-index: -1;
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.08) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.08) 1px, transparent 1px);
            background-size: 50px 50px;
        }

        svg { width: 100vw; height: 100vh; display: block; }

        /* --- 2. GAME OBJECTS --- */
        .food { fill: #ffff00; stroke: none; filter: drop-shadow(0 0 5px #ffff00); }
        .enemy-red { fill: #ff0000; stroke: #ffffff; stroke-width: 1.5; }
        .enemy-stalker { fill: #aa00ff; stroke: #ffffff; stroke-width: 1.5; }
        .particle { pointer-events: none; opacity: 0.8; }

        /* --- 3. UI --- */
        #ui { 
            position: absolute; top: 15px; width: 100%; text-align: center;
            color: #00ffff; pointer-events: none; z-index: 50; 
            text-shadow: 0 0 10px #00ffff;
            display: flex; flex-direction: column; align-items: center;
        }
        
        #score-label { font-size: 14px; color: #888; letter-spacing: 3px; margin-bottom: 5px; }
        #score { font-size: 45px; font-weight: 900; line-height: 1; }
        
        /* NEW ENERGY BAR STYLE */
        #boost-bar-container {
            width: 200px; height: 8px; background: #222; margin-top: 10px;
            border: 2px solid #555; border-radius: 4px; overflow: hidden;
        }
        #boost-fill { 
            width: 100%; height: 100%; 
            background: linear-gradient(90deg, #ff00ff, #aa00ff); 
            transition: width 0.1s linear; 
        }

        /* MISSION CARD */
        #mission-card {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0, 20, 0, 0.9); border: 2px solid #00ff00;
            padding: 10px; border-radius: 5px; z-index: 60;
            text-align: right; color: #fff; width: auto;
        }
        .mission-title { font-size: 10px; color: #00ff00; letter-spacing: 1px; }
        .mission-goal { font-size: 14px; font-weight: bold; margin: 2px 0; }
        .mission-status { font-size: 10px; color: #aaa; }
        .mission-status.completed { color: #00ff00; font-weight: bold; }

        /* --- 4. LOBBY OVERLAY --- */
        #overlay {
            position: fixed; inset: 0; background: rgba(5,5,5,0.96);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; z-index: 100;
        }

        .shop-box {
            width: 90%; max-width: 500px;
            background: #111; border: 2px solid #00ffff;
            padding: 20px; border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.1);
        }

        .skin-grid {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;
            max-height: 200px; overflow-y: auto; padding-right: 5px;
        }

        .skin-btn {
            aspect-ratio: 1; border: 2px solid #333; cursor: pointer;
            position: relative; transition: 0.2s;
        }
        .skin-btn.selected { border-color: #00ffff; box-shadow: 0 0 10px #00ffff; transform: scale(1.1); z-index: 2; }
        .skin-btn.locked { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
        .skin-btn.locked::after { content: 'üîí'; position: absolute; inset:0; display:grid; place-items:center; font-size:14px; }

        /* BUTTONS */
        button.start-btn {
            padding: 20px 60px;
            font-size: 24px; font-weight: 900; font-family: 'Courier New', monospace;
            color: #000; background: #00ffff;
            border: none; cursor: pointer;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.5);
            transition: transform 0.1s;
        }
        button.start-btn:active { transform: scale(0.95); }
        
        #lvl-msg {
            position: absolute; top:40%; left:50%; transform:translate(-50%,-50%);
            font-size: 30px; font-weight: bold; color: #ff0000; background: #000;
            padding: 10px; border: 2px solid #ff0000; opacity: 0; pointer-events: none;
            transition: opacity 0.5s; z-index: 200; text-align: center; width: 80%;
        }
    </style>
</head>
<body>

<div class="mech-grid"></div>

<div id="ui">
    <span id="score-label">DATA COLLECTED</span>
    <span id="score">0</span>
    <div id="boost-bar-container"><div id="boost-fill"></div></div>
    <div style="font-size: 10px; color:#ff00ff; margin-top:5px; letter-spacing:1px;">ENERGY LEVELS</div>
</div>

<div id="mission-card">
    <div class="mission-title">DAILY MISSION</div>
    <div class="mission-goal" id="mission-text">REACH 50 SCORE</div>
    <div class="mission-status" id="mission-status">PENDING...</div>
</div>

<div id="lvl-msg">‚ö†Ô∏è ENEMY DEPLOYED</div>

<div id="overlay">
    <h1 style="font-size: 4rem; margin: 0; color: #ff0033; letter-spacing: -3px; text-shadow: 3px 3px 0 #fff;">ESCAPE ME</h1>
    <p id="high-score-display" style="color: #ffff00; letter-spacing: 2px; font-size: 18px; margin-bottom: 20px; font-weight: bold;">BEST RUN: 0</p>
    
    <div class="shop-box">
        <div style="display:flex; justify-content:space-between; font-size:12px; color:#aaa; margin-bottom:10px;">
            <span>SKIN SELECTOR</span>
            <span>UNLOCKED: <span id="unlock-count" style="color:#fff">0</span></span>
        </div>
        <div class="skin-grid" id="skin-grid"></div>
    </div>
    
    <button class="start-btn" onclick="startGame()">INITIATE ESCAPE</button>
</div>

<svg id="game-canvas">
    <defs>
        <path id="segment" d="M0,-8 L6,-4 L6,4 L0,8 L-6,4 L-6,-4 Z" />
    </defs>
    <g id="particle-layer"></g>
    <g id="food-layer"></g>
    <g id="enemies-layer"></g>
    <g id="player-layer"></g>
</svg>

<script>
    /* --- AUDIO --- */
    const AudioEngine = {
        ctx: null,
        init: function() {
            try { window.AudioContext = window.AudioContext || window.webkitAudioContext; if(!this.ctx) this.ctx = new AudioContext(); } catch(e){}
        },
        play: function(type) {
            if (!this.ctx) return;
            const osc = this.ctx.createOscillator(), gain = this.ctx.createGain();
            osc.connect(gain); gain.connect(this.ctx.destination);
            const now = this.ctx.currentTime;
            
            if (type === 'eat') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(600, now); osc.frequency.linearRampToValueAtTime(1000, now + 0.1);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'die') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(50, now + 0.5);
                gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start(now); osc.stop(now + 0.5);
            }
        }
    };

    /* --- DATA & VARIABLES --- */
    const MISSION_TARGET = 50; 
    const STARTER_SKINS = 5; 

    const today = new Date().toDateString();
    let totalUnlocks = parseInt(localStorage.getItem('escape_unlocks_v3')) || 0;
    let lastUnlockDate = localStorage.getItem('escape_date_v3') || "";
    let highScore = parseInt(localStorage.getItem('escape_high_score')) || 0;
    
    let isMissionComplete = (lastUnlockDate === today);

    // Added 'energy' to player object
    const player = { segments: [], score: 0, color: '#00ffff', isBoosting: false, speed: 7, energy: 100 };
    let enemies = [], foodPellets = [], particles = [], pointer = { x: window.innerWidth/2, y: window.innerHeight/2 }, gameRunning = false;
    let frameCount = 0;

    /* --- UI UPDATES --- */
    function updateMissionUI() {
        const statusEl = document.getElementById('mission-status');
        if(isMissionComplete) {
            statusEl.innerText = "COMPLETED ‚úÖ";
            statusEl.classList.add("completed");
            document.getElementById('mission-text').innerText = "COME BACK TOMORROW";
        } else {
            statusEl.innerText = "IN PROGRESS...";
            statusEl.classList.remove("completed");
            document.getElementById('mission-text').innerText = `REACH ${MISSION_TARGET} SCORE`;
        }
    }

    function updateLobbyUI() {
        document.getElementById('high-score-display').innerText = `BEST RUN: ${highScore}`;
        document.getElementById('unlock-count').innerText = STARTER_SKINS + totalUnlocks;
        initSkinShop();
    }

    /* --- SKIN SYSTEM --- */
    function initSkinShop() {
        const grid = document.getElementById('skin-grid');
        grid.innerHTML = '';
        const unlockedCount = STARTER_SKINS + totalUnlocks;

        for(let i=0; i<100; i++) {
            const btn = document.createElement('div');
            const isUnlocked = i < unlockedCount;
            btn.className = 'skin-btn' + (isUnlocked ? '' : ' locked');
            
            let color = '';
            if(i===0) color='#00ffff'; 
            else if(i===1) color='#ff00ff'; 
            else if(i===2) color='#ffff00'; 
            else if(i===3) color='#00ff00'; 
            else if(i===4) color='#ffffff'; 
            else { const hue = (i * 20) % 360; color = `hsl(${hue}, 80%, 50%)`; }

            btn.style.background = color;
            btn.onclick = () => {
                if(isUnlocked) {
                    player.color = color;
                    document.querySelectorAll('.skin-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                }
            };
            if(player.color === color) btn.classList.add('selected');
            grid.appendChild(btn);
        }
    }

    /* --- GAME FUNCTIONS --- */
    function startGame() {
        AudioEngine.init();
        document.getElementById('overlay').style.display = 'none';
        
        document.getElementById('player-layer').innerHTML='';
        document.getElementById('enemies-layer').innerHTML='';
        document.getElementById('food-layer').innerHTML='';
        document.getElementById('particle-layer').innerHTML='';
        
        // Reset player stats
        player.segments = []; enemies = []; foodPellets = []; particles = []; 
        player.score = 0;
        player.energy = 100; // Reset Energy
        document.getElementById('score').innerText = "0";

        for(let i=0; i<20; i++) {
            player.segments.push(createSegment(document.getElementById('player-layer'), 'player', player.color, pointer.x, pointer.y));
        }

        spawnEnemy("enemy-red", "wander");
        for(let i=0; i<10; i++) spawnFood();
        
        gameRunning = true;
        update();
    }

    function createSegment(container, type, color, x, y) {
        const use = document.createElementNS("http://www.w3.org/2000/svg", "use");
        use.setAttributeNS("http://www.w3.org/1999/xlink", "href", "#segment");
        if(type === 'enemy') { use.setAttribute("class", color); } 
        else { use.style.fill = color; use.style.stroke = '#fff'; use.style.strokeWidth = '0.5'; }
        container.appendChild(use);
        return { x:x||0, y:y||0, use };
    }

    function spawnEnemy(className, state) {
        let segs = [];
        for(let i=0; i<15; i++) segs.push(createSegment(document.getElementById('enemies-layer'), 'enemy', className, -100, -100));
        enemies.push({ segments:segs, state:state, timer:2, type:className });
    }

    function spawnFood() {
        const x = 30 + Math.random()*(window.innerWidth-60);
        const y = 30 + Math.random()*(window.innerHeight-60);
        const el = document.createElementNS("http://www.w3.org/2000/svg", "path");
        el.setAttribute("d", "M0,-6 L6,0 L0,6 L-6,0 Z"); 
        el.setAttribute("transform", `translate(${x},${y})`);
        el.classList.add("food");
        document.getElementById('food-layer').appendChild(el);
        foodPellets.push({ x, y, use:el });
    }

    /* --- GAME LOOP --- */
    function update() {
        if(!gameRunning) return;
        frameCount++;

        // --- NEW BOOST LOGIC (ENERGY BASED) ---
        // Boost if clicking AND energy > 0
        if(player.isBoosting && player.energy > 0) {
            player.speed = 4; // Fast
            player.energy -= 0.6; // Drain Energy
            
            if(frameCount % 8 === 0) {
                const tail = player.segments[player.segments.length-1];
                createParticle(tail.x, tail.y, '#ff00ff'); // Purple Trail
            }
        } else {
            player.speed = 7; // Normal
            if(player.energy < 100) player.energy += 0.3; // Regenerate Energy
        }

        // Clamp Energy between 0 and 100
        if(player.energy < 0) player.energy = 0;
        if(player.energy > 100) player.energy = 100;
        
        // Update Energy Bar UI
        document.getElementById('boost-fill').style.width = player.energy + "%";

        // --- MOVE PLAYER ---
        const head = player.segments[0];
        head.x += (pointer.x - head.x) / player.speed;
        head.y += (pointer.y - head.y) / player.speed;
        head.use.setAttribute("transform", `translate(${head.x},${head.y}) scale(1.1)`);

        for(let i=1; i<player.segments.length; i++) {
            const s=player.segments[i], p=player.segments[i-1];
            s.x += (p.x - s.x) * 0.4;
            s.y += (p.y - s.y) * 0.4;
            
            let scale = 1.0;
            let distFromEnd = player.segments.length - i;
            if(distFromEnd < 6) scale = 0.4 + (distFromEnd * 0.1);
            s.use.setAttribute("transform", `translate(${s.x},${s.y}) scale(${scale})`);
        }

        // --- ENEMIES ---
        enemies.forEach(en => {
            en.timer -= 0.016;
            let tx, ty, spd = 40;
            
            if(en.type === 'enemy-stalker') {
                tx = player.segments[0].x + (pointer.x - player.segments[0].x);
                ty = player.segments[0].y + (pointer.y - player.segments[0].y);
                spd = 25; 
            } else {
                if(en.timer<=0) { en.state = en.state==='wander'?'strike':'wander'; en.timer=en.state==='strike'?1.5:3; }
                if(en.state==='strike') { tx=head.x; ty=head.y; spd=25; }
                else { tx=window.innerWidth/2 + Math.cos(Date.now()/1000 + enemies.indexOf(en))*300; ty=window.innerHeight/2 + Math.sin(Date.now()/1000)*300; }
            }
            
            let eh = en.segments[0];
            eh.x += (tx - eh.x)/spd; eh.y += (ty - eh.y)/spd;
            eh.use.setAttribute("transform", `translate(${eh.x},${eh.y})`);
            
            for(let i=1; i<en.segments.length; i++) {
                let s=en.segments[i], p=en.segments[i-1];
                s.x += (p.x - s.x)*0.4; s.y += (p.y - s.y)*0.4;
                s.use.setAttribute("transform", `translate(${s.x},${s.y}) scale(${1 - i/20})`);
            }
            if(Math.hypot(head.x - eh.x, head.y - eh.y) < 20) gameOver();
        });

        // --- FOOD ---
        foodPellets.forEach((f, i) => {
            if(Math.hypot(head.x - f.x, head.y - f.y) < 25) {
                f.use.remove(); foodPellets.splice(i, 1);
                AudioEngine.play('eat');
                player.score++;
                document.getElementById('score').innerText = player.score;
                
                const last = player.segments[player.segments.length-1];
                player.segments.push(createSegment(document.getElementById('player-layer'), 'player', player.color, last.x, last.y));
                
                if(player.score >= MISSION_TARGET && !isMissionComplete) {
                    isMissionComplete = true;
                    totalUnlocks++;
                    localStorage.setItem('escape_unlocks_v3', totalUnlocks);
                    localStorage.setItem('escape_date_v3', today);
                    showMsg("MISSION COMPLETE: SKIN UNLOCKED!");
                }
                
                if(player.score === 50) { spawnEnemy("enemy-stalker", "strike"); showMsg("‚ö†Ô∏è 2ND ENEMY DEPLOYED"); }
                spawnFood();
            }
        });

        for(let i=particles.length-1; i>=0; i--) {
            let p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.life-=0.1;
            p.el.setAttribute("transform", `translate(${p.x},${p.y})`); p.el.style.opacity=p.life;
            if(p.life<=0) { p.el.remove(); particles.splice(i,1); }
        }
        requestAnimationFrame(update);
    }

    function createParticle(x, y, color) {
        const p = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        p.setAttribute("width", 4); p.setAttribute("height", 4); p.style.fill=color;
        document.getElementById('particle-layer').appendChild(p);
        const a=Math.random()*6.28, s=3;
        particles.push({el:p, x, y, vx:Math.cos(a)*s, vy:Math.sin(a)*s, life:1});
    }

    function showMsg(txt) { const m=document.getElementById('lvl-msg'); m.innerText=txt; m.style.opacity=1; setTimeout(()=>m.style.opacity=0, 3000); }

    function gameOver() {
        gameRunning = false;
        AudioEngine.play('die');
        if(player.score > highScore) { highScore = player.score; localStorage.setItem('escape_high_score', highScore); }
        document.getElementById('overlay').style.display='flex';
        updateLobbyUI();
        updateMissionUI();
    }

    /* --- INPUTS --- */
    window.addEventListener('mousemove', e => { pointer.x = e.clientX; pointer.y = e.clientY; });
    window.addEventListener('touchmove', e => { pointer.x = e.touches[0].clientX; pointer.y = e.touches[0].clientY; }, {passive: false});
    window.addEventListener('mousedown', () => player.isBoosting = true);
    window.addEventListener('mouseup', () => player.isBoosting = false);
    window.addEventListener('touchstart', () => player.isBoosting = true, {passive:false});
    window.addEventListener('touchend', () => player.isBoosting = false);

    updateMissionUI();
    updateLobbyUI();
</script>
</body>
</html>
